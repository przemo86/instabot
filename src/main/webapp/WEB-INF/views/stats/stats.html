<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:include="fragments/layout :: head">
    <title th:text="#{view.about.title}">Welcome!</title>
</head>
<body>
<div class="wrapper">
    <div th:replace="fragments/layout :: header"></div>
    <div class="page-content-wrapper">
        <div th:replace="fragments/layout :: upperBar"></div>
        <div class="container-fluid gradient-background">
            <p class="lead text-left site-title">
                Statystyki
            </p>
        </div>
        <span th:text="${project.name}"/>
        <canvas id="canvas" style="width: 100%; height: 500px;"></canvas>

        <div id="details">

        </div>

        <script th:inline="javascript">
            var chartData = [[${chartData}]];
            var mylabels = [[${chartLabels}]];
            var chartLabels = [];
            mylabels.forEach(function (lbl) {
                chartLabels.push(new Date(lbl.split('###')[0]));
            });


            var ctx = $("#canvas")[0].getContext("2d");

            var myLineChart = new Chart(ctx, {
                type: "line",

                data: {
                    datasets: [
                        {
//                            steppedLine: 'before',
                            label: [[${project.name}]],
                            data: chartData,
                            borderColor: [[${chartColor}]],
                            fill: false
                        }
                    ],
                    labels: chartLabels
                },
                options: {
                    scales: {
                        xAxes: [
                            {
                                type: 'time',
                                time: {
                                    displayFormats: {
                                        second: 'YYYY/MMM HH:mm:ss'
                                    }
                                },
                                distribution: 'series',
                                position: "bottom",
                                ticks: {
                                    autoSkip: true,
                                    maxRotation: 90,
                                    minRotation: 90
                                }
                            }
                        ],
                        yAxes: [{
                            scaleLabel: {
                                display: true,
                                scaleLabel: {
                                    display: true,
                                    labelString: 'Ilość trafień'
                                }
                            }
                        }]
                    }
                }
            });

            $("#canvas").click(
                function (evt) {
                    var activePoints = myLineChart.getElementsAtEvent(evt);
                    var statId = mylabels[activePoints[0]._index].split('###')[1];
                    $.ajax({
                        url: "/stats/project?id=" + statId,
                        cache: false
                    }).done(function (html) {

                        var tab = '<table class="table project-table">' +
                            '                            <thead>' +
                            '                            <tr>' +
                            '                            <th>Media</th>' +
                            '                            <th>Link</th>' +
                            '                            <th>Tags</th>' +
                            '                            </tr>' +
                            '                            </thead>';
                        for (var row=0; row < html.length; row++) {

                            tab += '<tr>';
                            tab += '<td><img style="width: 50px" src="' + html[row].thumbnailUri + '" alt="' + html[row].thumbnailUri + '"/></td>';
                            tab += '<td><a href="' + html[row].link + '" target="_blank">' + html[row].link + '</a></td>';
                            tab += '<td>' + html[row].tags + '</td>';

                            tab += '</tr>';
                        }

                        tab += '</table>';

                        $("#details").empty();
                        $("#details").append(tab);
                    });
                }
            );
        </script>

        <div th:replace="fragments/layout :: footer"></div>
    </div>

</div>
</body>
</html>